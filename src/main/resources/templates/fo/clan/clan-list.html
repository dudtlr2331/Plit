<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_parameter" th:content="${_csrf.parameterName}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <title>클랜 찾기</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/clan.css" />
</head>
<body>

<div th:replace="~{fo/common/header :: header}"></div>

<div class="container">
  <div class="search-bar">
    <form method="get" action="/clan" id="searchForm">
      <div class="search-left">
        <select name="tier" onchange="document.getElementById('searchForm').submit()">
          <option value="" th:selected="${tier == null or tier == ''}">티어 전체</option>
          <option value="상관없음" th:selected="${tier == '상관없음'}">티어 상관 없음</option>
          <option value="아이언" th:selected="${tier == '아이언'}">아이언</option>
          <option value="브론즈" th:selected="${tier == '브론즈'}">브론즈</option>
          <option value="실버" th:selected="${tier == '실버'}">실버</option>
          <option value="골드" th:selected="${tier == '골드'}">골드</option>
          <option value="플레티넘" th:selected="${tier == '플레티넘'}">플레티넘</option>
          <option value="에메랄드" th:selected="${tier == '에메랄드'}">에메랄드</option>
          <option value="다이아" th:selected="${tier == '다이아'}">다이아</option>
          <option value="마스터" th:selected="${tier == '마스터'}">마스터</option>
          <option value="그랜드마스터" th:selected="${tier == '그랜드마스터'}">그랜드마스터</option>
          <option value="챌린저" th:selected="${tier == '챌린저'}">챌린저</option>
        </select>
        <input type="text" name="keyword" placeholder="클랜명 또는 소개 검색" />
        <button type="submit" class="btn">검색</button>
      </div>
    </form>

    <div sec:authorize="isAuthenticated()">
      <a href="javascript:void(0);" class="btn" onclick="openModal()">클랜등록</a>
    </div>
    <div sec:authorize="isAnonymous()">
      <a href="/login" class="btn">클랜등록</a>
    </div>

    <div id="clanModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>클랜 등록하기</h2>
        <form id="clanForm" method="post" action="/clan/register" enctype="multipart/form-data" style="padding: 0 16px;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div th:if="${error}" style="color: red; text-align: center; margin: 10px 0;">
            <p th:text="${error}"></p>
          </div>

          <!-- 클랜 이름 입력 -->
          <input
                  type="text"
                  name="name"
                  placeholder="클랜 이름"
                  required
                  style="margin-bottom: 6px;"
                  oninput="checkClanName(this.value)"
          />

          <div id="clanNameMessage" style="margin-bottom: 16px; font-size: 13px;"></div>

          <!-- 소환사 이름 표시 -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: bold; margin-bottom: 4px;">소환사 이름</label>
            <div style="padding: 10px; background-color: #f9f9f9; border: 1px solid #ccc; border-radius: 6px; color: #333;">
              <span th:text="${nickname}">닉네임</span>
            </div>
            <input type="hidden" name="summonerName" th:value="${nickname}" />
          </div>

          <label for="imageUpload" class="image-label" style="display: block; margin-bottom: 6px;">이미지 등록하기</label>

          <input type="file" id="imageUpload" name="imageFile" accept="image/*"
                 onchange="validateImageRatio(event)" style="margin-bottom: 10px;" />

          <img id="imagePreview" style="max-width: 100%; margin-bottom: 10px;" />

          <div style="font-size: 13px; color: gray; margin-bottom: 20px; line-height: 1.5;">
            <p style="margin: 0;">
              이미지는 <strong>4:3 비율</strong> (예: <strong>800×600</strong>)로 등록하는 것이 가장 예쁘게 보여요.
            </p>
            <p style="margin: 4px 0 0 0;">
              너무 길거나 정사각형에 가까운 이미지는 화면에서 깨져 보일 수 있어요!
            </p>
          </div>

          <textarea name="intro" placeholder="클랜 소개" required></textarea>
          <select name="minTier" required>
            <option value="">티어 선택</option>
            <option value="상관없음">티어 상관 없음</option>
            <option value="아이언">아이언</option>
            <option value="브론즈">브론즈</option>
            <option value="실버">실버</option>
            <option value="골드">골드</option>
            <option value="플레티넘">플레티넘</option>
            <option value="에메랄드">에메랄드</option>
            <option value="다이아">다이아</option>
            <option value="마스터">마스터</option>
            <option value="그랜드마스터">그랜드마스터</option>
            <option value="챌린저">챌린저</option>
          </select>
          <input type="url" name="discordLink" placeholder="디스코드 초대 주소" />
          <input type="url" name="kakaoLink" placeholder="카카오톡 오픈채팅 주소" />

          <div style="text-align: right;">
            <button type="submit" class="btn">등록하기</button>
            <button type="button" class="btn" onclick="closeModal()">취소</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="clan-grid">
    <div class="clan-card" th:each="clan : ${clans}" th:onclick="|location.href='/clan/${clan.id}'|" style="cursor: pointer;">
      <div class="clan-image-placeholder">
        <img th:src="${clan.imageUrl != null and clan.imageUrl != ''} ? @{${clan.imageUrl}} : @{/images/clan/clan_default.png}"
             alt="클랜 이미지"
             class="clan-image"
             onerror="this.onerror=null; this.src='/images/clan/clan_default.png';" />
      </div>

      <div th:if="${linkError}" class="error-msg" style="color: red; text-align: center; font-weight: bold;">
        <p th:text="${linkError}"></p>
      </div>

      <div class="clan-title-box">
        <h3 th:text="${clan.name}">클랜이름</h3>
        <span class="clan-member-count">0명</span>
      </div>

      <p th:text="${clan.intro}">소개글</p>

      <small style="display: flex; align-items: center; width: 100%;">
        <span style="padding-left: 0.75rem; flex-shrink: 0;"
              th:text="${clan.minTier == '챌린저' ? '챌린저' :
                       (clan.minTier == '상관없음' ? '티어 상관 없음' :
                       clan.minTier + ' 이상')}"></span>
        <div style="flex-grow: 1;"></div>
        <span class="clan-links" style="padding-right: 0.75rem; display: flex; gap: 4px;">
          <a th:if="${clan.discordLink != null and !#strings.isEmpty(clan.discordLink)}" th:href="${clan.discordLink}" target="_blank" onclick="event.stopPropagation()">
            <img src="/images/clan/discord-icon.png" alt="Discord" class="social-icon" />
          </a>
          <a th:if="${clan.kakaoLink != null and !#strings.isEmpty(clan.kakaoLink)}" th:href="${clan.kakaoLink}" target="_blank" onclick="event.stopPropagation()">
            <img src="/images/clan/kakao-icon.png" alt="KakaoTalk" class="social-icon" />
          </a>
        </span>
      </small>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="footer-nav">
      <a href="#">공지사항</a>
      <a href="#">사용방법</a>
      <a href="#">개인정보처리방침</a>
      <a href="#">광고/제휴문의</a>
      <a href="#">개발문의</a>
      <a href="#">404 Squad</a>
    </div>
    <div>
      lol.ps is hosted by PS Analytics, Inc. This site isn't endorsed by Riot Games and doesn’t reflect their views.
      League of Legends is a trademark of Riot Games.
    </div>
  </div>
</footer>

<script>
  function openModal() {
    document.getElementById("clanModal").style.display = "block";
  }
  function closeModal() {
    document.getElementById("clanModal").style.display = "none";
  }

  function toggleChatList() {
    alert('채팅 리스트 열기 구현 필요');
  }

  function validateImageRatio(event) {
    const file = event.target.files[0];
    if (!file) return;

    const img = new Image();
    const reader = new FileReader();

    reader.onload = function (e) {
      img.src = e.target.result;
    };

    img.onload = function () {
      const width = img.width;
      const height = img.height;
      const ratio = width / height;

      const minRatio = 0.5;   // 4:3보다 약간 좁은 비율
      const maxRatio = 2.5;   // 4:3보다 약간 넓은 비율

      if (ratio < minRatio || ratio > maxRatio) {
        alert("업로드 전 이미지 비율을 확인해주세요.\n4:3 비율 이미지 (예: 800×600, 1200x900, 1600×1200 등)가 가장 깔끔하게 표시됩니다.");
        event.target.value = ""; // 업로드 취소
        document.getElementById("imagePreview").src = ""; // 미리보기도 제거
      } else {
        document.getElementById("imagePreview").src = img.src;
      }
    };

    reader.readAsDataURL(file);
  }

  function checkClanName(name) {
    const msgDiv = document.getElementById("clanNameMessage");

    if (!name || name.length < 2) {
      msgDiv.textContent = "클랜 이름은 2자 이상 입력해주세요!";
      msgDiv.style.color = "gray";
      return;
    }

    fetch(`/clan/check-name?name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(data => {
              if (data) {
                msgDiv.textContent = "사용 가능한 클랜 이름이에요!";
                msgDiv.style.color = "green";
              } else {
                msgDiv.textContent = "이미 존재하는 클랜 이름입니다.";
                msgDiv.style.color = "red";
              }
            })
            .catch(() => {
              msgDiv.textContent = "서버 오류가 발생했어요. 잠시 후 다시 시도해주세요.";
              msgDiv.style.color = "orange";
            });
  }

  async function validateForm() {
    const nameInput = document.querySelector("input[name='name']");
    const name = nameInput.value.trim();
    const msgDiv = document.getElementById("clanNameMessage");

    // 비어있거나 너무 짧으면 막기
    if (name.length < 2) {
      alert("클랜 이름은 2자 이상 입력해주세요!");
      nameInput.focus();
      return false;
    }

    // 중복 여부 확인
    try {
      const res = await fetch(`/clan/check-name?name=${encodeURIComponent(name)}`);
      const isAvailable = await res.json();

      if (!isAvailable) {
        alert("이미 존재하는 클랜 이름입니다. 다른 이름을 입력해주세요!");
        nameInput.focus();
        return false; // 제출 막기
      }

      return true; // 제출 허용
    } catch (e) {
      alert("서버 오류가 발생했습니다. 다시 시도해주세요!");
      return false;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("clanForm");

    form.addEventListener("submit", async function (event) {
      event.preventDefault();

      const isValid = await validateForm();

      if (isValid) {
        form.submit();
      }
    });
  });
</script>
</body>
</html>