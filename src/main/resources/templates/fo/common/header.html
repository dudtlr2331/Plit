<div th:fragment="header"
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

    <header>
        <meta name="login-user-seq" th:if="${loginUser != null}" th:content="${loginUser.userSeq}" />

        <a th:href="@{/main}" class="logo">
            <img th:src="@{/images/logo/plit_logo_w.png}" alt="Logo" style="height: 30px;">
        </a>

        <nav>
            <a th:href="@{/party}">파티찾기</a>
            <a th:href="@{/clan}">클랜찾기</a>
            <a th:href="@{/report}">트롤신고</a>
        </nav>

        <div class="header-user-area">
            <div class="chat-icon" onclick="toggleChatList()">💬</div>

            <!-- 로그인 상태 -->
            <div sec:authorize="isAuthenticated()" class="auth-area">
                <span th:text="${nickname}">닉네임</span>

                <button class="btn btn-mypage" onclick="location.href='/mypage'">마이페이지</button>

                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-logout">로그아웃</button>
                </form>
            </div>

            <!-- 비로그인 상태 -->
            <div sec:authorize="isAnonymous()">
                <button class="btn btn-login" onclick="location.href='/login'">로그인</button>
            </div>
        </div>

        <!-- 채팅 목록 팝업 -->
        <div id="chatListPopup" class="chat-list-popup">
            <h4>채팅 목록</h4>
            <div id="chatListContainer"></div>
        </div>

        <!-- 채팅 팝업 -->
        <div id="chatPopup" class="chat-popup">
            <div id="chatTarget">상대 닉네임</div>
            <div id="chatBody" class="chat-body"></div>
            <input id="chatInput" type="text" placeholder="메시지를 입력하세요">
        </div>

        <script>
            const currentUserId = document.querySelector('meta[name="login-user-seq"]')?.getAttribute('content');
            let stompClient = null;
            let currentRoomId = null;

            function toggleChatList() {
                const popup = document.getElementById("chatListPopup");
                popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'block' : 'none';

                if (!currentUserId) {
                    alert("로그인이 필요합니다.");
                    return;
                }

                if (popup.style.display === 'block') {
                    loadChatList();
                }
            }

            function loadChatList() {
                fetch(`/api/chat/rooms/${currentUserId}`)
                    .then(res => res.json())
                    .then(data => {
                        const container = document.getElementById('chatListContainer');
                        container.innerHTML = '';

                        if (data.length === 0) {
                            container.innerHTML = '<div class="chat-list-empty">참여한 채팅방이 없습니다.</div>';
                            return;
                        }

                        data.forEach(room => {
                            const div = document.createElement('div');
                            div.className = 'chat-list-item';
                            div.textContent = room.otherNickname + (room.unreadCount > 0 ? ` (${room.unreadCount})` : '');
                            div.onclick = () => openChatWithFriendManually(room.roomId, room.otherUserId, room.otherNickname);
                            container.appendChild(div);
                        });
                    });
            }

            function openChatWithFriendManually(roomId, otherUserId, nickname) {
                currentRoomId = roomId;

                document.getElementById('chatTarget').textContent = nickname;
                document.getElementById('chatPopup').style.display = 'flex';
                document.getElementById('chatInput').focus();
                document.getElementById('chatListPopup').style.display = 'none';

                loadPreviousMessages(roomId);
                connectToChatRoom(roomId);
            }

            function loadPreviousMessages(roomId) {
                fetch(`/api/chat/${roomId}`)
                    .then(res => res.json())
                    .then(messages => {
                        const chatBody = document.getElementById('chatBody');
                        chatBody.innerHTML = '';
                        messages.forEach(msg => appendMessage(msg.content, msg.sender == currentUserId, msg.senderNickname, msg.sentAt));
                        chatBody.scrollTop = chatBody.scrollHeight;
                    });
            }

            function appendMessage(content, isMine, nickname, sentAt) {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-message-wrapper ' + (isMine ? 'sent' : 'received');

                wrapper.innerHTML = `
        <div class="chat-nickname">${nickname}</div>
        <div class="chat-bubble">${content}</div>
        <div class="chat-time">${formatDateTime(sentAt)}</div>
    `;
                const chatBody = document.getElementById('chatBody');
                chatBody.appendChild(wrapper);

                chatBody.scrollTop = chatBody.scrollHeight;
            }

            function formatDateTime(sentAt) {
                const date = new Date(sentAt);
                return date.toLocaleString();
            }





            function connectToChatRoom(roomId) {
                if (stompClient) stompClient.disconnect();

                const socket = new SockJS('/ws-stomp');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, () => {
                    stompClient.subscribe(`/sub/chat/room/${roomId}`, (message) => {
                        const msg = JSON.parse(message.body);
                        appendMessage(msg.content, msg.sender == currentUserId, msg.senderNickname, msg.sentAt);
                    });
                });
            }

            document.getElementById('chatInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && stompClient && currentRoomId) {
                    const content = e.target.value.trim();
                    if (!content) return;

                    stompClient.send("/pub/chat/send", {}, JSON.stringify({
                        roomId: currentRoomId,
                        sender: currentUserId,
                        content: content
                    }));

                    e.target.value = '';
                }
            });
        </script>

        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    </header>
</div>
