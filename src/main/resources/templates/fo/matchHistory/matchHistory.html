<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>플레이어 전적 페이지</title>

    <link rel="stylesheet" th:href="@{/css/matchHistory.css}">

    <script>
        function loadMatchDetail(element) {
            const matchId = element.getAttribute("data-match-id");
            const puuid = element.getAttribute("data-puuid");

            const detailBox = element.nextElementSibling; // 🔧 핵심 수정!

            if (detailBox.getAttribute("data-loaded") === "true") {
                detailBox.style.display = detailBox.style.display === "none" ? "block" : "none";
                return;
            }

            fetch(`/fo/match/detail?matchId=${matchId}&puuid=${puuid}`)
                .then(res => res.json())
                .then(data => {
                    const table = detailBox.querySelector(".match-detail-table");

                    const makeRow = (player, isWin) => {
                        const damageDealt = (player.totalDamageDealtToChampions * 100 / data.totalMaxDamage).toFixed(1);
                        const damageTaken = (player.totalDamageTaken * 100 / data.totalMaxDamage).toFixed(1);
                        const csPerMin = player.csPerMin.toFixed(2);
                        const itemsHtml = player.itemImageUrls.map(img => img ? `<img src="${img}" class="item-icon">` : '').join('');

                        return `
                <tr class="${isWin ? 'win-row' : 'lose-row'}">
                    <td><img src="${player.profileIconUrl}" class="profile-icon" onerror="this.onerror=null; this.src='/img/default-icon.png';" /> ${player.summonerName}</td>
                    <td>${player.tier}</td>
                    <td>${player.kills}/${player.deaths}/${player.assists}</td>
                    <td>
                        <div class="damage-bar">
                            <div class="damage-dealt" style="width:${damageDealt}%"></div>
                            <div class="damage-taken" style="width:${damageTaken}%"></div>
                        </div>
                    </td>
                    <td>설치 : ${player.wardsPlaced}<br />제거 : ${player.wardsKilled}</td>
                    <td>총 CS : ${player.cs}<br />분당 : ${csPerMin}</td>
                    <td>${itemsHtml}</td>
                </tr>
                `;
                    };

                    const blueRows = data.blueTeam.map(p => makeRow(p, true)).join('');
                    const redRows = data.redTeam.map(p => makeRow(p, false)).join('');

                    table.innerHTML += `
                <tr class="team-summary"><td colspan="7">블루팀</td></tr>
                <tr><th>소환사</th><th>티어</th><th>KDA</th><th>피해량</th><th>와드</th><th>CS</th><th>아이템</th></tr>
                ${blueRows}
                <tr class="vs-row"><td colspan="7" class="vs-cell">VS</td></tr>
                <tr class="team-summary"><td colspan="7">레드팀</td></tr>
                <tr><th>소환사</th><th>티어</th><th>KDA</th><th>피해량</th><th>와드</th><th>CS</th><th>아이템</th></tr>
                ${redRows}
            `;

                    detailBox.style.display = "block";
                    detailBox.setAttribute("data-loaded", "true");
                })
                .catch(err => {
                    console.error("상세 정보 로딩 실패", err);
                    detailBox.innerHTML = "<p>데이터 로딩 실패</p>";
                });
        }
    </script>

</head>
<body>
<header>
    <nav>
        <a href="/party">파티찾기</a>
        <a href="/battle">내전찾기</a>
        <a href="/clan">클랜찾기</a>
        <a href="/report">트롤신고</a>
    </nav>
    <nav>
        <button class="chat-button" onclick="toggleChatList()">💬</button>
        <a href="/login">로그인</a>
    </nav>
    <div id="chatList" class="chat-popup">
        <div>채팅방1</div>
        <div>채팅방2</div>
    </div>
</header>

<div class="profile-header">
    <img th:src="@{'https://ddragon.leagueoflegends.com/cdn/14.12.1/img/profileicon/' + ${summoner.profileIconId} + '.png'}" alt="프로필 아이콘"/>
    <h2 th:text="${summoner.gameName} + ' #' + ${summoner.tagLine}">플레이어1 #KR1</h2>
    <button style="margin-left: auto;" class="btn-red">전적갱신</button>
</div>

<div class="tabs">
    <button class="tab active">전체</button>
    <button class="tab">개인/2인 랭크 게임</button>
    <button class="tab">자유 랭크 게임</button>
</div>

<div class="main">
    <div class="left-panel">

        <div class="rank-box">
            <div class="rank-box">
                <h3>개인/2인 랭크 게임</h3>
                <div class="tier-summary" th:if="${rankMap['RANKED_SOLO_5x5'] != null}">
                    <img th:src="@{'/img/emblem-' + ${rankMap['RANKED_SOLO_5x5'].tier.toLowerCase()} + '.png'}"
                         class="tier-icon" alt="현재 티어" />

                    <div class="tier-info">
                        <div class="tier-name" th:text="${rankMap['RANKED_SOLO_5x5'].tier + ' ' + rankMap['RANKED_SOLO_5x5'].rank}">
                            tier
                        </div>
                        <div class="lp" th:text="${rankMap['RANKED_SOLO_5x5'].leaguePoints + ' LP'}">
                            leaguepoints
                        </div>
                        <div class="win-rate"
                             th:text="${rankMap['RANKED_SOLO_5x5'].wins + '승 ' + rankMap['RANKED_SOLO_5x5'].losses + '패 · 승률 ' + #numbers.formatDecimal(rankMap['RANKED_SOLO_5x5'].winRate, 0, 0) + '%'}">
                            win-rate
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="rank-box">
            <h3>자유 랭크 게임</h3>
            <div class="tier-summary" th:if="${rankMap['RANKED_FLEX_SR'] != null}">
                <img th:src="@{'/img/emblem-' + ${rankMap['RANKED_FLEX_SR'].tier.toLowerCase()} + '.png'}"
                     class="tier-icon" alt="현재 티어" />

                <div class="tier-info">
                    <div class="tier-name"
                         th:text="${rankMap['RANKED_FLEX_SR'].tier + ' ' + rankMap['RANKED_FLEX_SR'].rank}">
                        tier
                    </div>
                    <div class="lp"
                         th:text="${rankMap['RANKED_FLEX_SR'].leaguePoints + ' LP'}">
                        lp
                    </div>
                    <div class="win-rate"
                         th:text="${rankMap['RANKED_FLEX_SR'].wins + '승 ' + rankMap['RANKED_FLEX_SR'].losses + '패 · 승률 ' + #numbers.formatDecimal(rankMap['RANKED_FLEX_SR'].winRate, 0, 0) + '%'}">
                        win-rate
                    </div>
                </div>
            </div>

            <div class="no-rank-info" th:if="${rankMap['RANKED_FLEX_SR'] == null}">
                <p style="color: gray; font-size: 14px;">자유 랭크 정보가 없습니다.</p>
            </div>
        </div>

        <div class="champion-preference-box">
            <h2>선호챔피언</h2>
            <h3 th:text="'S' + ${T(java.time.Year).now().value}">year</h3>
            <div class="champion-row" th:each="champ : ${favoriteChampions}">
                <div class="champion-icon">
                    <img th:src="@{'https://ddragon.leagueoflegends.com/cdn/14.12.1/img/champion/' + ${champ.name} + '.png'}"
                         alt="champion" />
                </div>
                <div class="champion-info">
                    <div class="champ-name" th:text="${champ.korName}">루시안</div>
                    <div class="cs-info" th:text="'CS ' + ${champ.totalCs} + ' (' + ${#numbers.formatDecimal(champ.csPerMin, 1, 1)} + ')'">
                        CS
                    </div>
                </div>

                <div class="kda-info">
                    <div class="kda-ratio" th:text="${#numbers.formatDecimal(champ.kdaRatio, 2, 2) + ':1 평점'}">3.09:1 평점</div>
                    <div class="kda" th:text="${champ.kills} + ' / ' + ${champ.deaths} + ' / ' + ${champ.assists}">8.4 / 4.3 / 5.1</div>
                </div>

                <div class="usage-info">
                    <div class="usage-percent" th:text="${champ.flexUsagePercent + '%'}" style="color:#f45b5b;">63%</div>
                    <div class="game-count" th:text="${champ.flexGameCount + '게임'}">76게임</div>
                </div>
            </div>

            <div class="show-more">모든 시즌 티어 보기 ⌄</div>
        </div>

    </div>
    <div class="right-panel">

        <div class="recent-games">
            <h3>최근 게임 (전체)</h3>

            <div th:if="${matchList != null}">

                <div class="kda-summary">

                    <div class="match-summary-block">
                        <p class="match-record-text"
                           th:text="${summary.totalCount} + '전 ' + ${summary.winCount} + '승 ' + ${summary.loseCount} + '패'">
                            20전 16승 4패
                        </p>

                        <div class="win-loss-bar">
                            <div class="win-bar"
                                 th:style="'width:' + (${summary.winCount * 100.0 / summary.totalCount}) + '%'">
                                <span th:text="${summary.winCount} + '승'">16승</span>
                            </div>
                            <div class="lose-bar"
                                 th:style="'width:' + (${summary.loseCount * 100.0 / summary.totalCount}) + '%'">
                                <span th:text="${summary.loseCount} + '패'">4패</span>
                            </div>
                        </div>

                        <p class="win-rate-text"
                           th:text="${#numbers.formatDecimal(summary.winCount * 100.0 / summary.totalCount, 0, 0)} + '%'">
                            53%
                        </p>
                    </div>

                    <!-- 아래는 기존 kda 등 유지 -->
                    <div class="kda-stat">
                        <div class="label">K/D/A</div>
                        <div>
                            <strong th:text="${#numbers.formatDecimal(summary.avgKills, 1, 1)}">0.0</strong> /
                            <span style="color:red;" th:text="${#numbers.formatDecimal(summary.avgDeaths, 1, 1)}">0.0</span> /
                            <span th:text="${#numbers.formatDecimal(summary.avgAssists, 1, 1)}">0.0</span>
                        </div>
                        <div th:text="${#numbers.formatDecimal(summary.kdaRatio, 2, 2)} + ' : 1'">0.00 : 1</div>
                        <div style="color:red; font-size: 12px;"
                             th:text="|킬 관여 ${#numbers.formatDecimal(summary.killParticipation, 1, 1)}%|">
                            킬 관여
                        </div>
                    </div>


                    <!-- 챔피언 상위 3개 -->
                    <div class="favorite-champions-section">
                        <h4 class="section-title">최근 선호 챔피언</h4>
                        <div class="favorite-champions">
                            <div class="champion" th:each="entry : ${summary.sortedChampionList.subList(0, 3)}">
                                <img th:src="@{'https://ddragon.leagueoflegends.com/cdn/14.12.1/img/champion/' + ${entry.key} + '.png'}"
                                     th:alt="${entry.key}" />
                                <div class="percentage"
                                     th:text="${summary.championWinRates[entry.key]} + '%'">승률</div>
                                <div class="record"
                                     th:text="${summary.championTotalGames[entry.key]} + '전 '
                                            + ${summary.championWins[entry.key]} + '승 '
                                            + (${summary.championTotalGames[entry.key]} - ${summary.championWins[entry.key]}) + '패'">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 선호 포지션 -->
                    <div class="favorite-positions">
                        <h4 class="section-title">최근 선호 포지션</h4>
                        <div class="position-bar-container">
                            <div class="position"
                                 th:each="pos : ${summary.sortedPositionList}">

                                <div class="position-bar">
                                    <div class="fill"
                                         th:with="value=${summary.favoritePositions[pos]}"
                                         th:style="'height:' + ((value != null ? value * 100.0 / summary.totalCount : 0)) + '%'">
                                    </div>
                                </div>

                                <img th:src="@{'/img/position-' + ${pos.toLowerCase()} + '.png'}"
                                     th:alt="${pos}" class="position-icon" />
                            </div>
                        </div>
                    </div>

                </div>
            </div>

                <div th:each="match : ${matchList}">
                    <div class="match-summary-box"
                         th:attr="data-match-id=${match.matchId}, data-puuid=${summoner.puuid}"
                         th:classappend="${match.win} ? 'win-bg' : 'lose-bg'"
                         onclick="loadMatchDetail(this)">

                        <div class="champion-icon">
                            <img th:src="@{'https://ddragon.leagueoflegends.com/cdn/14.12.1/img/champion/' + ${match.championName} + '.png'}" alt="챔피언">
                        </div>

                        <div class="match-summary-main">
                            <div><strong th:text="${match.championName}"></strong> (<span th:text="${modeMap[match.gameMode]} ?: '기타 모드'"></span>)</div>
                            <div>포지션: <span th:text="${match.teamPosition}"></span></div>
                            <div>KDA: <span th:text="${match.kills + '/' + match.deaths + '/' + match.assists}"></span> |
                                CS: <span th:text="${match.cs}"></span> (<span th:text="${match.csPerMin}"></span>)</div>
                            <div th:if="${match.killParticipation != null}">킬관여율: <span th:text="${match.killParticipation} + '%'">킬관여율</span></div>
                            <div>결과: <span th:text="${match.win} ? '승리' : '패배'"></span> |
                                티어: <span th:text="${match.tier}"></span></div>
                            <div th:if="${match.gameDurationMinutes != null}" th:text="${match.gameDurationMinutes} + '분 ' + ${match.gameDurationSeconds} + '초'"></div>
                        </div>

                        <div class="match-items">
                            <img th:each="imgUrl : ${match.itemImageUrls}"
                                 th:if="${imgUrl != null}"
                                 th:src="${imgUrl}"
                                 alt="아이템">
                        </div>
                    </div>

                    <div class="match-detail" style="display: none;">
                        <table class="match-detail-table"></table>
                    </div>
                </div>
            <div th:if="${#lists.isEmpty(matchList)}">
                <p>불러온 전적이 없습니다.</p>
            </div>
        </div>
    </div>
</div>
</body>
</html>

