<div th:fragment="listFragment">
    <h2>나의 문의 내역</h2>

    <table class="qna-table">
        <thead>
        <tr>
            <th>번호</th>
            <th>제목</th>
            <th>첨부</th>
            <th>상태</th>
            <th>작성일</th>
            <th>삭제</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="qna, stat : ${questions}">
            <td th:text="${stat.index + 1}">1</td>
            <td>
                <a th:href="@{/mypage/qna/view/{id}(id=${qna.id})}"
                   th:text="${qna.title}">제목</a>
            </td>
            <td>
                <span th:if="${qna.fileName}">📎</span>
            </td>
            <td>
                <span th:class="'qna-status-badge ' + (${qna.status} == '답변완료' ? 'completed' : 'pending')"
                      th:text="${qna.status}">상태</span>
            </td>
            <td th:text="${#temporals.format(qna.askedAt, 'yyyy.MM.dd HH:mm')}">날짜</td>
            <td>
                <form th:action="@{/mypage/qna/delete/{id}(id=${qna.id})}" method="post">
                    <button type="submit" class="qna-delete-btn"
                            onclick="return confirm('정말 삭제할까요?')">삭제</button>
                </form>
            </td>
        </tr>

        <!-- 비어있을 때 -->
        <tr th:if="${#lists.isEmpty(questions)}">
            <td colspan="6">문의 내역이 없습니다.</td>
        </tr>
        </tbody>
    </table>

    <div class="qna-actions">
        <a th:href="@{/mypage/qna/write}" class="qna-submit-button">➕ 새 문의</a>
<!--        <button onclick="openChat()" class="qna-chat-btn">💬 실시간 문의</button>-->
        <button onclick="requestChat()" class="qna-chat-btn">💬 실시간 문의</button>
    </div>

    <div id="chatPopup" class="chat-popup" style="display: none;">
        <div class="chat-header">
            실시간 문의
            <button onclick="toggleChat()">✖</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요...">
            <button onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        function toggleChat() {
            const popup = document.getElementById("chatPopup");
            popup.style.display = popup.style.display === "none" ? "flex" : "none";
        }

        // 👉 버튼 클릭 시 팝업 열기용 함수
        function requestChat() {
            toggleChat(); // 나중에 여기에 서버에 요청 보내는 코드도 추가할 수 있어!
        }

        const roomId = "admin-room";
        const userId = "plit유저"; // TODO: 실제 로그인 사용자 ID로 대체하기

        const ws = new WebSocket(`wss://${location.host}/ws/chat?roomId=${roomId}&userId=${userId}`);

        ws.onmessage = (event) => {
            const msgBox = document.getElementById("chatMessages");
            const div = document.createElement("div");
            div.textContent = event.data;
            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
        };

        function sendMessage() {
            const input = document.getElementById("messageInput");
            if (input.value.trim()) {
                ws.send(input.value);
                input.value = "";
            }
        }
    </script>
</div>