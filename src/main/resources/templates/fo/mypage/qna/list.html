<div th:fragment="listFragment">
    <h2>ë‚˜ì˜ ë¬¸ì˜ ë‚´ì—­</h2>

    <table class="qna-table">
        <thead>
        <tr>
            <th>ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th>ì²¨ë¶€</th>
            <th>ìƒíƒœ</th>
            <th>ì‘ì„±ì¼</th>
            <th>ì‚­ì œ</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="qna, stat : ${questions}">
            <td th:text="${stat.index + 1}">1</td>
            <td>
                <a th:href="@{/mypage/qna/view/{id}(id=${qna.id})}"
                   th:text="${qna.title}">ì œëª©</a>
            </td>
            <td>
                <span th:if="${qna.fileName}">ğŸ“</span>
            </td>
            <td>
                <span th:class="'qna-status-badge ' + (${qna.status} == 'ë‹µë³€ì™„ë£Œ' ? 'completed' : 'pending')"
                      th:text="${qna.status}">ìƒíƒœ</span>
            </td>
            <td th:text="${#temporals.format(qna.askedAt, 'yyyy.MM.dd HH:mm')}">ë‚ ì§œ</td>
            <td>
                <form th:action="@{/mypage/qna/delete/{id}(id=${qna.id})}" method="post">
                    <button type="submit" class="qna-delete-btn"
                            onclick="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')">ì‚­ì œ</button>
                </form>
            </td>
        </tr>

        <!-- ë¹„ì–´ìˆì„ ë•Œ -->
        <tr th:if="${#lists.isEmpty(questions)}">
            <td colspan="6">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
        </tbody>
    </table>

    <div class="qna-actions">
        <a th:href="@{/mypage/qna/write}" class="qna-submit-button">â• ìƒˆ ë¬¸ì˜</a>
<!--        <button onclick="openChat()" class="qna-chat-btn">ğŸ’¬ ì‹¤ì‹œê°„ ë¬¸ì˜</button>-->
        <button onclick="requestChat()" class="qna-chat-btn">ğŸ’¬ ì‹¤ì‹œê°„ ë¬¸ì˜</button>
    </div>

    <div id="chatPopup" class="chat-popup" style="display: none;">
        <div class="chat-header">
            ì‹¤ì‹œê°„ ë¬¸ì˜
            <button onclick="toggleChat()">âœ–</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        function toggleChat() {
            const popup = document.getElementById("chatPopup");
            popup.style.display = popup.style.display === "none" ? "flex" : "none";
        }

        // ğŸ‘‰ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°ìš© í•¨ìˆ˜
        function requestChat() {
            toggleChat(); // ë‚˜ì¤‘ì— ì—¬ê¸°ì— ì„œë²„ì— ìš”ì²­ ë³´ë‚´ëŠ” ì½”ë“œë„ ì¶”ê°€í•  ìˆ˜ ìˆì–´!
        }

        const roomId = "admin-room";
        const userId = "plitìœ ì €"; // TODO: ì‹¤ì œ ë¡œê·¸ì¸ ì‚¬ìš©ì IDë¡œ ëŒ€ì²´í•˜ê¸°

        const ws = new WebSocket(`wss://${location.host}/ws/chat?roomId=${roomId}&userId=${userId}`);

        ws.onmessage = (event) => {
            const msgBox = document.getElementById("chatMessages");
            const div = document.createElement("div");
            div.textContent = event.data;
            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
        };

        function sendMessage() {
            const input = document.getElementById("messageInput");
            if (input.value.trim()) {
                ws.send(input.value);
                input.value = "";
            }
        }
    </script>
</div>