<div th:fragment="friendsFragment">
  <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>ì¹œêµ¬ ëª©ë¡</h2>
        <div style="position: relative; display: inline-block;">
          <button onclick="toggleRequestPopup()" class="submit-button">ì¹œêµ¬ ì‹ ì²­</button>

          <div id="requestPopup" class="request-popup" style="display: none;">
            <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding: 8px;">
              <span>ì¹œêµ¬ ìš”ì²­ ëª©ë¡</span>
              <button onclick="toggleRequestPopup()">Ã—</button>
            </div>
            <div id="requestList" style="padding: 10px;"></div>
          </div>
        </div>
  </div>

      <div th:if="${#lists.isEmpty(friendList)}" class="friend-item">
        <div class="friend-left">
          <div class="profile-circle"></div>
          <span>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
        </div>
      </div>

      <div th:each="friend : ${friendList}" class="friend-item">
        <div class="friend-left">
          <div class="profile-circle"></div>
          <span th:text="${friend.user.userNickname}">ë‹‰ë„¤ì„</span>
          <input class="memo-input" th:value="${friend.memo}" readonly />
          <button class="memo-edit-btn" th:attr="data-friendsno=${friend.friendsNo}, data-currentmemo=${friend.memo}" onclick="openMemoPopup(this)">âœï¸</button>
        </div>
        <div class="friend-actions">
          <button class="chat-btn"
                  th:attr="data-myid=${loginUser.userSeq}, data-otherid=${friend.user.userSeq}, data-nickname=${friend.user.userNickname}"
                  onclick="openChatWithFriend(this)">ğŸ’¬</button>
          <button class="block-btn"
                  th:attr="onclick=|blockFriend(${friend.friendsNo})|">ì°¨ë‹¨</button>
          <button class="delete-btn"
                  th:attr="onclick=|deleteFriend(${friend.friendsNo})|">ì‚­ì œ</button>
        </div>
      </div>

<!-- ì±„íŒ… íŒì—… -->
<div class="chat-popup" id="chatPopup">
  <div class="chat-header">
    <span id="chatTarget">í”Œë ˆì´ì–´</span>
    <button onclick="closeChat()">Ã—</button>
  </div>
  <div class="chat-body" id="chatBody">
    <div class="chat-message received"></div>
  </div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
  </div>
</div>

<!--ë©”ëª¨ ìˆ˜ì • íŒì—…-->
<div id="memoPopup" class="chat-popup" style="width: 300px;">
  <div class="chat-header">
    <span>ë©”ëª¨ ìˆ˜ì •</span>
    <button onclick="closeMemoPopup()">Ã—</button>
  </div>
  <div class="chat-body">
    <input type="hidden" id="memoFriendId" />
    <textarea id="memoInputArea" rows="4" style="width: 100%; padding: 10px;"></textarea>
  </div>
  <div style="padding: 10px;">
    <button class="submit-button" onclick="submitMemo()">ì €ì¥</button>
  </div>
</div>

<script>
  let stompClient = null;
  let currentRoomId = null;
  const currentUserSeq = document.querySelector('meta[name="login-user-seq"]').getAttribute('content');
  const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');


  function loadFriendRequests() {
    fetch('/api/friends/requests')
            .then(async res => {
              if (!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨: ' + res.status);
              const text = await res.text();
              return text ? JSON.parse(text) : [];
            })
            .then(data => {
              const container = document.getElementById('requestList');
              container.innerHTML = '';

              if (data.length === 0) {
                container.innerHTML = '<p>ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
              }

              data.forEach(req => {
                const div = document.createElement('div');
                div.className = 'request-item';
                div.textContent = `From: ${req.fromUserNickname} (${req.fromUserId})`;
                container.appendChild(div);
              });
            });
  }

  // ì´ì „ ë©”ì„¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadPreviousMessages(roomId) {
    fetch(`/api/chat/${roomId}`)
            .then(res => res.json())
            .then(messages => {
              const body = document.getElementById('chatBody');
              body.innerHTML = '';
              messages.forEach(msg => {
                appendMessage(msg.content, msg.sender == currentUserSeq);
              });
            });
  }

  function openChatWithFriend(btn) {
    const myId = btn.getAttribute("data-myid");
    const otherId = btn.getAttribute("data-otherid");
    const nickname = btn.getAttribute("data-nickname");

    if (!myId || !otherId) {
      alert("ì¹œêµ¬ ì •ë³´ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }

    fetch(`/api/chat/room/${myId}/${otherId}`)
            .then(res => res.json())
            .then(roomId => {
              document.getElementById('chatTarget').textContent = nickname;
              document.getElementById('chatPopup').style.display = 'flex';
              document.getElementById('chatInput').focus();
              loadPreviousMessages(roomId);
              connectToChatRoom(roomId);
            });
  }

  function makeRoomId(userA, userB) {
    return (parseInt(userA) < parseInt(userB))
            ? `user-${userA}_${userB}`
            : `user-${userB}_${userA}`;
  }


  function closeChat() {
    document.getElementById('chatPopup').style.display = 'none';
    document.getElementById('chatBody').innerHTML = '';
    document.getElementById('chatInput').value = '';
    if (stompClient) stompClient.disconnect();
  }

  document.getElementById('chatInput')?.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && this.value.trim()) {
      const msg = this.value.trim();
      const div = document.createElement('div');
      div.className = 'chat-message sent';
      div.textContent = msg;
      document.getElementById('chatBody').appendChild(div);
      this.value = '';
      document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight;
    }
  });

  //ë©”ëª¨ ìˆ˜ì •
  function openMemoPopup(btn) {
    const friendNo = btn.getAttribute("data-friendsno");
    const currentMemo = btn.getAttribute("data-currentmemo");

    document.getElementById("memoFriendId").value = friendNo;
    document.getElementById("memoInputArea").value = currentMemo;

    document.getElementById("memoPopup").style.display = "flex";
  }

  function closeMemoPopup() {
    document.getElementById("memoPopup").style.display = "none";
  }

  function submitMemo() {
    const friendNo = document.getElementById("memoFriendId").value;
    const newMemo = document.getElementById("memoInputArea").value;

    fetch(`/api/friends/${friendNo}/memo`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        [csrfHeader]: csrfToken
      },
      body: JSON.stringify({ memo: newMemo })
    })
            .then(res => {
              if (res.ok) {
                alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
              } else {
                alert("ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
  }

  // ì¹œêµ¬ ì‹ ì²­ ëª©ë¡
  function loadFriendRequests() {
    fetch('/api/friends/requests')
            .then(res => res.json())
            .then(data => {
              const container = document.getElementById('requestList');
              container.innerHTML = '';

              if (data.length === 0) {
                container.innerHTML = '<p>ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
              }

              data.forEach(req => {
                const div = document.createElement('div');
                div.className = 'request-item';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.marginBottom = '10px';

                const nickname = document.createElement('span');
                nickname.textContent = req.user.userNickname;
                nickname.style.flex = '1';

                const memo = document.createElement('span');
                memo.textContent = req.memo || '';
                memo.style.flex = '2';
                memo.style.margin = '0 10px';

                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '5px';

                const acceptBtn = document.createElement('button');
                acceptBtn.textContent = 'ìˆ˜ë½';
                acceptBtn.className = 'submit-button';
                acceptBtn.onclick = () => handleFriendAction(req.friendsNo, 'accept');

                const declineBtn = document.createElement('button');
                declineBtn.textContent = 'ê±°ì ˆ';
                declineBtn.className = 'delete-btn';
                declineBtn.onclick = () => handleFriendAction(req.friendsNo, 'decline');

                actions.appendChild(acceptBtn);
                actions.appendChild(declineBtn);

                div.appendChild(nickname);
                div.appendChild(memo);
                div.appendChild(actions);

                container.appendChild(div);
              });
            });
  }


  // ì¹œêµ¬ì‹ ì²­ ìˆ˜ë½ ë° ê±°ì ˆ
  function handleFriendAction(friendNo, action) {
    fetch(`/api/friends/${friendNo}/${action}`, {
      headers: {
        [csrfHeader]: csrfToken
      },
      method: "POST"
    }).then(res => {
      if (res.ok) {
        alert(`${action === 'accept' ? 'ìˆ˜ë½' : 'ê±°ì ˆ'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        loadFriendRequests();
      } else {
        alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  function toggleRequestPopup() {
    const popup = document.getElementById('requestPopup');
    popup.style.display = popup.style.display === 'flex' ? 'none' : 'flex';

    if (popup.style.display === 'flex') {
      loadFriendRequests();
    }
  }

  // ì¹œêµ¬ ì°¨ë‹¨
  function blockFriend(friendNo) {
    if (!confirm('ì •ë§ ì´ ì¹œêµ¬ë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/api/friends/${friendNo}/block`, {
      headers: {
        [csrfHeader]: csrfToken
      },
      method: "POST"
    })
            .then(res => {
              if (res.ok) {
                alert("ì¹œêµ¬ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.");
                location.reload();
              } else {
                alert("ì°¨ë‹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
  }

  // ì¹œêµ¬ ì‚­ì œ
  function deleteFriend(friendNo) {
    if (!confirm('ì •ë§ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/api/friends/${friendNo}`, {
      headers: {
        [csrfHeader]: csrfToken
      },
      method: "DELETE"
    })
            .then(res => {
              if (res.ok) {
                alert("ì¹œêµ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
              } else {
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            });
  }


  //// ì›¹ ì†Œì¼“

  function connectToChatRoom(roomId) {
    if (stompClient && stompClient.connected) {
      stompClient.disconnect(() => {
        console.log("ê¸°ì¡´ stomp ì—°ê²° ì¢…ë£Œ");
        doConnect(roomId);
      });
    } else {
      doConnect(roomId);
    }
  }

  function doConnect(roomId) {
    const socket = new SockJS('/ws/chat');
    stompClient = Stomp.over(socket);
    currentRoomId = roomId;

    stompClient.connect({}, () => {
      console.log("Connected to room " + roomId);
      stompClient.subscribe(`/sub/chat/room/${roomId}`, message => {
        const msg = JSON.parse(message.body);
        if (msg.sender == currentUserSeq) return; // ì¤‘ë³µ ë°©ì§€
        appendMessage(msg.content, false);
      });
    });

    replaceChatInput(roomId);
  }

  function replaceChatInput(roomId) {
    const input = document.getElementById('chatInput');
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);

    newInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && this.value.trim()) {
        const msg = this.value.trim();
        stompClient.send("/pub/chat/send", {}, JSON.stringify({
          sender: currentUserSeq,
          content: msg,
          roomId: roomId
        }));
        appendMessage(msg, true);
        this.value = '';
      }
    });
  }

  function appendMessage(msg, isMine) {
    const div = document.createElement('div');
    div.className = 'chat-message ' + (isMine ? 'sent' : 'received');
    div.textContent = msg;
    const body = document.getElementById('chatBody');
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
  }

</script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

</div>